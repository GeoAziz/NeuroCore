
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Collection Group Rules for Admin ---
    // These are required for the Admin Panel's "Scan Control Center" and "Logs & Analytics" pages
    // which perform queries across all users' subcollections.
    
    // Allow admins to read any document in the 'neural_scans' collection group.
    match /{path=**}/neural_scans/{scanId} {
      allow read: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Allow admins to read any document in the 'accessLogs' collection group.
    match /{path=**}/accessLogs/{logId} {
      allow read: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // --- User Profile Rules ---
    match /users/{userId} {
      // Any authenticated user can read any other user's profile for basic info (e.g., display name for logs).
      // This is a 'get' rule, so it only applies to direct document reads, not queries on the collection.
      allow get: if request.auth != null;
      
      // Users can only update their own profile.
      allow update: if request.auth.uid == userId;
      
      // Admins can read/write any user profile.
      allow read, write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // --- Patient-Specific Subcollection Rules ---
    match /users/{patientId}/{subcollection}/{docId} {
       // Patients can read and write to their own subcollections.
       allow read, write: if request.auth.uid == patientId;
       
       // Doctors can read their assigned patients' subcollections.
       allow read: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'doctor'
                   && patientId in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.patients;
    }
    
    // --- Global Collection Rules ---
    match /alerts/{alertId} {
      // Doctors can read alerts assigned to them.
      allow read: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'doctor'
                  && resource.data.doctorId == request.auth.uid;
                  
      // Admins can read and write all alerts.
      allow read, write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Allow admins to read from any other top-level collection needed for the admin panel.
    match /therapyContent/{contentId} {
        allow read: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
  }
}
