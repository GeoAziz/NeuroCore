
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to get the user's role from their profile
    function getUserRole(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.role;
    }

    // Helper function to check if a doctor is assigned to a patient
    function isDoctorForPatient(doctorId, patientId) {
      return get(/databases/$(database)/documents/users/$(doctorId)).data.patients[patientId] == true;
    }
    
    // --- Admin Rules ---
    // Admins have broad read access to the entire database for oversight.
    // Write access is more restricted in a real app, but enabled here for the prototype.
    match /{path=**}/users/{userId} {
       allow read, write: if getUserRole(request.auth.uid) == 'admin';
    }

    match /users/{userId}/{subcollection}/{docId} {
      allow read, write: if getUserRole(request.auth.uid) == 'admin';
    }
     match /alerts/{alertId} {
      allow read, write: if getUserRole(request.auth.uid) == 'admin';
    }

    // --- User Profile Rules ---
    // Users can read and update their own profile.
    match /users/{userId} {
      allow read, update: if request.auth.uid == userId;
      // Allow doctors to read their assigned patients' profiles.
      allow read: if getUserRole(request.auth.uid) == 'doctor' && isDoctorForPatient(request.auth.uid, userId);
    }
    
    // --- Patient Subcollection Rules ---
    // Patients can access their own subcollections.
    match /users/{patientId}/{subcollection}/{docId} {
        allow read, write, list: if request.auth.uid == patientId;
    }
    
    // Doctors can read subcollections of their assigned patients.
    match /users/{patientId}/{subcollection}/{docId} {
        allow read, list: if getUserRole(request.auth.uid) == 'doctor' && isDoctorForPatient(request.auth.uid, patientId);
    }

    // --- Alerts Collection Rules ---
    // Doctors can read alerts that are assigned to them.
    match /alerts/{alertId} {
      allow read: if request.auth.uid == resource.data.doctorId;
    }
  }
}
